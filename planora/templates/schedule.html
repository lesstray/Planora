{% extends 'layout.html' %}
{% load static %}
{% load extras %}

{% block title %}Planora ‚Äì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ{% endblock %}
{% block content %}
<div class="home-container">
  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º -->
  <div class="schedule-controls">
    <form method="GET" action="{% url 'home:schedule' %}" class="schedule-form">
      <div class="form-row">
        <div class="input-block">
          <label for="groupNumber">–ù–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã</label>
          <input type="text" id="groupNumber" name="groupNumber"
                 value="{{ selected_group }}" required>
        </div>
        <div class="input-block">
          <label for="scheduleDate">–î–∞—Ç–∞</label>
          <input type="date" id="scheduleDate" name="scheduleDate"
                 value="{{ selected_date }}" required>
        </div>
      </div>
      <button type="submit" class="auth-button">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
    </form>
  </div>

  <!-- –ü–æ–∏—Å–∫ -->
  <div class="search-container">
    <input type="text" id="search-input"
           placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é, –∞—É–¥–∏—Ç–æ—Ä–∏–∏, –∑–∞–º–µ—Ç–∫–∞–º...">
  </div>

  {% if schedule_by_date %}
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º -->
    <div class="week-info"
         data-week-start="{{ week_start|date:'Y-m-d' }}"
         data-group="{{ selected_group }}">
      <span class="prev-week">&larr;</span>
      <strong>–ù–µ–¥–µ–ª—è:&nbsp;</strong>
      {{ week_start|date:"d F Y" }} ‚Äì {{ week_end|date:"d F Y" }}
      <span class="next-week">&rarr;</span>
    </div>
    <a href="{% url 'home:export_ics' %}?groupNumber={{ selected_group }}&scheduleDate={{ selected_date }}" class="auth-button" style="margin-left:1em">
      –≠–∫—Å–ø–æ—Ä—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å (.ics)
    </a>
    <div class="schedule-wrapper">
      {# –ü–ù‚Äì–°–† #}
      <div class="schedule-row first-row">
        {% for date, events in schedule_by_date|slice:":3" %}
          <div class="day-column">
            <div class="day-header">{{ date|date:"l, d F" }}</div>
            <button class="add-task-button" data-date="{{ date|date:'Y-m-d' }}">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
            <div class="events-list">
              {% for ev in events %}
                {% with st=ev.start_time en=ev.end_time notes=ev.notes %}
                <div class="schedule-line {% if ev.done %}done{% elif ev.type == 'task' %}pending{% endif %}"
                     data-key="{{ date|date:'Y-m-d' }}_{{ st }}"
                     data-notes="{{ notes|default:'' }}"
                >
                  <div class="line-content">
                    <div><strong>{{ st }}{% if en %}‚Äì{{ en }}{% endif %}</strong></div>
                    {% if ev.type == 'lesson' %}
                      <div>{{ ev.subject }}</div>
                      <div>{{ ev.teacher }}</div>
                      <div>{{ ev.place }}</div>
                      {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                    {% else %}
                      <div>{{ ev.description }}</div>
                      {% if ev.place %}<div><em>{{ ev.place }}</em></div>{% endif %}
                      {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                      {% if ev.attachment %}
                        <div><a href="{{ ev.attachment.url }}" target="_blank">üìé –§–∞–π–ª</a></div>
                      {% endif %}
                      <button
                        class="delete-task-button"
                        data-task-id="{{ ev.id }}"
                        style="color: red; margin-top:5px;"
                      >
                        –£–¥–∞–ª–∏—Ç—å
                      </button>
                    {% endif %}
                  </div>
                </div>
                {% endwith %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>

      {# –ß–¢‚Äì–°–ë #}
      <div class="schedule-row second-row">
        {% for date, events in schedule_by_date|slice:"3:6" %}
          <div class="day-column {{ date|date:'EEEE'|lower }}">
            <div class="day-header">{{ date|date:"l, d F" }}</div>
            <button class="add-task-button" data-date="{{ date|date:'Y-m-d' }}">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
            <div class="events-list">
              {% for ev in events %}
                {% with st=ev.start_time en=ev.end_time notes=ev.notes %}
                <div class="schedule-line {% if ev.done %}done{% elif ev.type == 'task' %}pending{% endif %}"
                     data-key="{{ date|date:'Y-m-d' }}_{{ st }}"
                     data-notes="{{ notes|default:'' }}"
                >
                  <div class="line-content">
                    <div><strong>{{ st }}{% if en %}‚Äì{{ en }}{% endif %}</strong></div>
                    {% if ev.type == 'lesson' %}
                      <div>{{ ev.subject }}</div>
                      <div>{{ ev.teacher }}</div>
                      <div>{{ ev.place }}</div>
                      {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                    {% else %}
                      <div>{{ ev.description }}</div>
                      {% if ev.place %}<div><em>{{ ev.place }}</em></div>{% endif %}
                      {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                      {% if ev.attachment %}
                        <div><a href="{{ ev.attachment.url }}" target="_blank">üìé –§–∞–π–ª</a></div>
                      {% endif %}
                      <button
                        class="delete-task-button"
                        data-task-id="{{ ev.id }}"
                        style="color: red; margin-top:5px;"
                      >
                        –£–¥–∞–ª–∏—Ç—å
                      </button>
                    {% endif %}
                  </div>
                </div>
                {% endwith %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>

      {# –í–° #}
      <div class="schedule-row third-row">
        {% for date, events in schedule_by_date|slice:"6:7" %}
          <div class="day-column {{ date|date:'EEEE'|lower }}">
            <div class="day-header">{{ date|date:"l, d F" }}</div>
            <button class="add-task-button" data-date="{{ date|date:'Y-m-d' }}">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
            <div class="events-list">
              {% for ev in events %}
                {% with st=ev.start_time en=ev.end_time notes=ev.notes %}
                <div class="schedule-line {% if ev.done %}done{% elif ev.type == 'task' %}pending{% endif %}"
                     data-key="{{ date|date:'Y-m-d' }}_{{ st }}"
                     data-notes="{{ notes|default:'' }}"
                >
                  <div class="line-content">
                    <div><strong>{{ st }}{% if en %}‚Äì{{ en }}{% endif %}</strong></div>
                    {% if ev.type == 'lesson' %}
                      <div>{{ ev.subject }}</div>
                      <div>{{ ev.teacher }}</div>
                      <div>{{ ev.place }}</div>
                      {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                    {% else %}
                      <div>{{ ev.description }}</div>
                      {% if ev.place %}<div><em>{{ ev.place }}</em></div>{% endif %}
                      {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                      {% if ev.attachment %}
                        <div><a href="{{ ev.attachment.url }}" target="_blank">üìé –§–∞–π–ª</a></div>
                      {% endif %}
                      <button
                        class="delete-task-button"
                        data-task-id="{{ ev.id }}"
                        style="color: red; margin-top:5px; align: center;"
                      >
                        –£–¥–∞–ª–∏—Ç—å
                      </button>
                    {% endif %}
                  </div>
                </div>
                {% endwith %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

{# –ú–æ–¥–∞–ª–∫–∞ –¥–µ—Ç–∞–ª–µ–π #}
<div id="modal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3 style="text-align:center;">–î–µ—Ç–∞–ª–∏</h3>
    <div id="modal-body">
      <p><strong>–í—Ä–µ–º—è:</strong> <span id="modal-time"></span></p>
      <p><strong>–¢–∏–ø:</strong> <span id="modal-type"></span></p>
      <p id="modal-subject"><strong>–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞:</strong> <span></span></p>
      <p id="modal-teacher"><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> <span></span></p>
      <p id="modal-place"><strong>–ê—É–¥–∏—Ç–æ—Ä–∏—è:</strong> <span></span></p>
      <p id="modal-desc"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span></span></p>
      <p><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ <input type="checkbox" id="modal-done"></label></p>
      <label for="notes">–ó–∞–º–µ—Ç–∫–∏:</label>
      <textarea id="notes" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É..."></textarea>
      <button class="delete-task-button" data-task-id="" style="color:red;margin-top:5px;">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

{# –ú–æ–¥–∞–ª–∫–∞ –¥–µ—Ç–∞–ª–µ–π –ø–∞—Ä—ã/–∑–∞–¥–∞—á–∏ #}
<div id="modal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3 style="text-align:center;">–î–µ—Ç–∞–ª–∏</h3>
    <div id="modal-body">
      <p><strong>–î–µ–Ω—å:</strong> <span id="modal-day"></span></p>
      <p><strong>–í—Ä–µ–º—è:</strong> <span id="modal-time"></span></p>
      <p><strong>–¢–∏–ø:</strong> <span id="modal-type"></span></p>
      <p id="modal-subject"><strong>–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞:</strong> <span></span></p>
      <p id="modal-teacher"><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> <span></span></p>
      <p id="modal-place"><strong>–ê—É–¥–∏—Ç–æ—Ä–∏—è:</strong> <span></span></p>
      <p id="modal-desc"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span></span></p>
      <p>
        <label>
          –í—ã–ø–æ–ª–Ω–µ–Ω–æ&nbsp;
          <input type="checkbox" id="modal-done">
        </label>
      </p>
      <label for="notes">–ó–∞–º–µ—Ç–∫–∏:</label>
      <textarea id="notes" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É..."></textarea>
      <button class="delete-task-button" data-task-id="{{ ev.id }}" style="color: red; margin-top:5px;">–£–¥–∞–ª–∏—Ç—å
      </button>
    </div>
  </div>
</div>

{# –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ #}
<div id="task-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeTaskModal()">&times;</span>
    <h3 style="text-align:center;">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
    <form id="task-form" method="post" action="{% url 'home:create_task' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="group" value="{{ selected_group }}">
      <input type="hidden" name="date" id="task-date">

      <div class="input-block">
        <label for="task-time">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</label>
        <input type="time" id="task-time" name="start_time" required>
      </div>

      <div class="input-block">
        <label for="task-end-time">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
        <input type="time" id="task-end-time" name="end_time">
      </div>

      <div class="input-block">
        <label for="task-place">–ú–µ—Å—Ç–æ:</label>
        <input type="text" id="task-place" name="place">
      </div>

      <div class="input-block">
        <label for="task-desc">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
        <textarea id="task-desc" name="description" required></textarea>
      </div>

      <div class="input-block">
        <label for="task-notes">–ó–∞–º–µ—Ç–∫–∏:</label>
        <textarea id="task-notes" name="notes"></textarea>
      </div>

      <div class="input-block">
        <label for="task-file">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª:</label>
        <input type="file" id="task-file" name="attachment">
      </div>

      <div class="input-block">
        <label><input type="checkbox" name="done"> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
      </div>

      <button type="submit" class="auth-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </form>
  </div>
</div>

{# –°–∫—Ä–∏–ø—Ç—ã: –º–æ–¥–∞–ª–∫–∏, –∑–∞–º–µ—Ç–∫–∏, —Å—Ç–∞—Ç—É—Å—ã, —Å—Ç—Ä–µ–ª–∫–∏, –ø–æ–∏—Å–∫ #}
<script>
  const storageKey = 'planora_notes';
  let allNotes = JSON.parse(localStorage.getItem(storageKey) || '{}');

  function openModal(day, time, subject, teacher, place, type='lesson', desc='') {
    const wi = document.querySelector('.week-info');
    const weekStart = wi.dataset.weekStart;
    const key = `${weekStart}_${day}_${time}`;

    document.getElementById('modal-day').innerText        = day;
    document.getElementById('modal-time').innerText       = time;
    document.getElementById('modal-type').innerText       = type === 'lesson' ? '–ü–∞—Ä–∞' : '–ó–∞–¥–∞—á–∞';
    document.getElementById('modal-subject').style.display= type==='lesson'?'block':'none';
    document.getElementById('modal-teacher').style.display= type==='lesson'?'block':'none';
    document.getElementById('modal-place').style.display  = type==='lesson'?'block':'none';
    document.getElementById('modal-desc').style.display   = type==='task'?'block':'none';

    if(type==='lesson'){
      document.querySelector('#modal-subject span').innerText = subject;
      document.querySelector('#modal-teacher span').innerText = teacher;
      document.querySelector('#modal-place span').innerText   = place;
    } else {
      document.querySelector('#modal-desc span').innerText    = desc;
    }

    document.getElementById('notes').value = (allNotes[key]&&allNotes[key].note)||'';
    document.getElementById('modal-done').checked = (allNotes[key]&&allNotes[key].done)||false;

    const modal = document.getElementById('modal');
    modal.dataset.currentKey = key;
    modal.classList.remove('hidden');
    modal.style.display = 'block';
  }

  function closeModal() {
    const modal = document.getElementById('modal');
    const key = modal.dataset.currentKey;
    const note = document.getElementById('notes').value;
    const done = document.getElementById('modal-done').checked;
    allNotes[key] = { note, done };
    localStorage.setItem(storageKey, JSON.stringify(allNotes));

    const cell = document.querySelector(`.schedule-line[data-key="${key}"]`);
    if (cell) {
      cell.classList.toggle('done', done);
      cell.classList.toggle('pending', !done);
    }
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }

  function openTaskModal(date) {
    document.getElementById('task-date').value = date;
    const m = document.getElementById('task-modal');
    m.classList.remove('hidden');
    m.style.display = 'block';
  }

  function closeTaskModal() {
    const m = document.getElementById('task-modal');
    m.classList.add('hidden');
    m.style.display = 'none';
  }

  document.addEventListener('DOMContentLoaded', () => {
    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
    document.querySelectorAll('.schedule-line').forEach(cell=> {
      const key = cell.dataset.key, info = allNotes[key];
      if(info){
        cell.classList.toggle('done', info.done);
        cell.classList.toggle('pending', !info.done);
      }
    });

    // –∫–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ
    document.querySelectorAll('.schedule-line').forEach(cell=>{
      cell.addEventListener('click', ()=>{
        const [ , day, time ] = cell.dataset.key.split('_');
        const content = cell.querySelector('.line-content');
        const subject = content.children[1]?.innerText||'';
        const teacher = content.children[2]?.innerText||'';
        const place   = content.children[3]?.innerText||'';
        const desc    = content.children[1]?.innerText||'';
        const type    = content.children.length>3?'lesson':'task';
        openModal(day, time, subject, teacher, place, type, desc);
      });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É"
    document.querySelectorAll('.add-task-button').forEach(button => {
    button.addEventListener('click', () => {
      const date = button.dataset.date;
      openTaskModal(date);
    });
  });

    // —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    const wi  = document.querySelector('.week-info'),
          grp = wi.dataset.group,
          [wy,wm,wd] = wi.dataset.weekStart.split('-').map(n=>+n),
          form = document.querySelector('.schedule-form'),
          dateInput = document.getElementById('scheduleDate');

    function shiftWeek(delta){
      let dt=new Date(wy,wm-1,wd); dt.setDate(dt.getDate()+delta);
      const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'),
            d=String(dt.getDate()).padStart(2,'0'), newDate=`${y}-${m}-${d}`;
      dateInput.value=newDate; form.submit();
    }
    document.querySelector('.prev-week').onclick = ()=>shiftWeek(-7);
    document.querySelector('.next-week').onclick = ()=>shiftWeek(+7);

    // –ø–æ–∏—Å–∫
    document.getElementById('search-input').addEventListener('input', function(){
      const q = this.value.toLowerCase();
      document.querySelectorAll('.schedule-line').forEach(line=>{
        const content = line.querySelector('.line-content').innerText.toLowerCase();
        const notes   = (line.dataset.notes   || '').toLowerCase();
        const desc    = (line.dataset.desc    || '').toLowerCase();
        const subj    = (line.dataset.subject || '').toLowerCase();
        const haystack = content + ' ' + notes + ' ' + desc + ' ' + subj;
        line.style.display = haystack.includes(q) ? '' : 'none';
      });
    });
  });
</script>


<script>
document.querySelectorAll('.task-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
        const taskId = this.dataset.taskId;

        fetch(`/toggle_task_done/${taskId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskDiv = document.getElementById(`task-${taskId}`);
                if (data.done) {
                    taskDiv.classList.remove('not-done');
                    taskDiv.classList.add('done');
                } else {
                    taskDiv.classList.remove('done');
                    taskDiv.classList.add('not-done');
                }
            }
        });
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.delete-task-button').forEach(btn => {
    btn.addEventListener('click', async e => {
      const id = btn.dataset.taskId;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;

      // —Å–æ–±—Ä–∞—Ç—å CSRF‚Äë—Ç–æ–∫–µ–Ω
      function getCookie(name) {
        let v = null;
        document.cookie.split(';').forEach(c => {
          let [k,val] = c.trim().split('=');
          if (k === name) v = decodeURIComponent(val);
        });
        return v;
      }
      const csrftoken = getCookie('csrftoken');

      try {
        const resp = await fetch("{% url 'home:delete_task' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({ task_id: id })
        });
        const data = await resp.json();
        if (data.success) {
          // –ª–∏–±–æ —É–¥–∞–ª—è–µ–º —Å—Ä–∞–∑—É –∏–∑ DOM:
          //btn.closest('.schedule-line').remove();
          // –ª–∏–±–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É:
          location.reload();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
      } catch (err) {
        alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
      }
    });
  });
});
</script>

<style>
  input[type="text"],
  input[type="time"],
  input[type="date"],
  input[type="file"],
  textarea {
    color: black; /* —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
    background-color: white; /* —Ñ–æ–Ω */
    border: 1px solid #ccc;
    padding: 6px;
    border-radius: 4px;
    width: 100%;
    box-sizing: border-box;
  }

  textarea::placeholder,
  input::placeholder {
    color: #888;
  }
</style>

{% endblock %}
