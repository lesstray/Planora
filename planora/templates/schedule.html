{% extends 'layout.html' %}
{% load static %}
{% load extras %}

{% block title %}Planora ‚Äì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ{% endblock %}
{% block content %}


{% if user_role == 'student' %}
  <div class="home-container">
    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º -->
    <div class="schedule-controls">
      <form method="GET" action="{% url 'home:schedule' %}" class="schedule-form">
        <div class="form-row">
          <div class="input-block">
            <label for="groupNumber">–ù–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã</label>
            <input type="text" id="groupNumber" name="groupNumber"
                   value="{{ selected_group }}" placeholder="–≤–∞—à–∞ –≥—Ä—É–ø–ø–∞ (–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è)">
          </div>
          <div class="input-block">
            <label for="scheduleDate">–î–∞—Ç–∞</label>
            <input type="date" id="scheduleDate" name="scheduleDate"
                   value="{{ selected_date }}">
          </div>
        </div>
        <button type="submit" class="auth-button">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
      </form>
    </div>

    <!-- –ü–æ–∏—Å–∫ -->
    <div class="search-container">
      <input type="text" id="search-input"
             placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é, –∞—É–¥–∏—Ç–æ—Ä–∏–∏, –∑–∞–º–µ—Ç–∫–∞–º...">
    </div>

    {% if schedule_by_date %}
      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º -->
      <div class="week-info"
           data-week-start="{{ week_start|date:'Y-m-d' }}"
           data-group="{{ selected_group }}">
        <span class="prev-week">&larr;</span>
        <strong>–ù–µ–¥–µ–ª—è:&nbsp;</strong>
        {{ week_start|date:"d F Y" }} ‚Äì {{ week_end|date:"d F Y" }}
        <span class="next-week">&rarr;</span>
      </div>
      <a href="{% url 'home:export_ics' %}?groupNumber={{ selected_group }}&scheduleDate={{ selected_date }}" class="auth-button" style="margin-left:1em">
        –≠–∫—Å–ø–æ—Ä—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å (.ics)
      </a>
      <div class="schedule-wrapper">
        {# –ü–ù‚Äì–°–† #}
        <div class="schedule-row first-row">
          {% for date, events in schedule_by_date|slice:":3" %}
            <div class="day-column">
              <div class="day-header">{{ date|date:"l, d F" }}</div>
              <button class="add-task-button" data-date="{{ date|date:'Y-m-d' }}">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
              <div class="events-list">
                {% for ev in events %}
                  {% with st=ev.start_time en=ev.end_time notes=ev.notes %}
                  <div class="schedule-line {% if ev.done %}done{% elif ev.type == 'task' %}pending{% endif %}"
                       data-key="{{ date|date:'Y-m-d' }}_{{ st }}"
                       data-notes="{{ notes|default:'' }}"
                       data-type="{{ ev.type }}"
                       data-day="{{ date|date:'d.m.Y' }}"
                       data-time="{{ st }}{% if en %}‚Äì{{ en }}{% endif %}"
                       data-lesson-id="{{ ev.id }}"
                       {% if ev.type == 'lesson' %}
                         data-type="lesson"
                         data-lesson-id="{{ ev.id }}"
                         data-subject="{{ ev.subject }}"
                         data-teacher="{{ ev.teacher }}"
                         data-place="{{ ev.place }}"
                       {% else %}
                         data-type="task"
                         data-description="{{ ev.description }}"
                         data-place="{{ ev.place }}"
                         data-task-id="{{ ev.id }}"
                         {% if ev.attachment %}
                          data-attachment-url="{{ ev.attachment.url }}"
                          data-attachment-name="{{ ev.attachment.name|basename }}"
                        {% endif %}
                       {% endif %}
                  >
                    <div class="line-content">
                      <div><strong>{{ st }}{% if en %}‚Äì{{ en }}{% endif %}</strong></div>
                      {% if ev.type == 'lesson' %}
                        <div>{{ ev.subject }}</div>
                        <div>{{ ev.teacher }}</div>
                        <div>{{ ev.place }}</div>
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                      {% else %}
                        <div>{{ ev.description }}</div>
                        {% if ev.place %}<div><em>{{ ev.place }}</em></div>{% endif %}
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                        {% if ev.attachment %}
                          <div><a href="{{ ev.attachment.url }}" target="_blank">üìé –§–∞–π–ª</a></div>
                        {% endif %}
                        <button
                          class="delete-task-button"
                          data-task-id="{{ ev.id }}"
                          style="color: red; margin-top:5px;"
                        >
                          –£–¥–∞–ª–∏—Ç—å
                        </button>
                      {% endif %}
                    </div>
                  </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>

        {# –ß–¢‚Äì–°–ë #}
        <div class="schedule-row second-row">
          {% for date, events in schedule_by_date|slice:"3:6" %}
            <div class="day-column {{ date|date:'EEEE'|lower }}">
              <div class="day-header">{{ date|date:"l, d F" }}</div>
              <button class="add-task-button" data-date="{{ date|date:'Y-m-d' }}">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
              <div class="events-list">
                {% for ev in events %}
                  {% with st=ev.start_time en=ev.end_time notes=ev.notes %}
                  <div class="schedule-line {% if ev.done %}done{% elif ev.type == 'task' %}pending{% endif %}"
                       data-key="{{ date|date:'Y-m-d' }}_{{ st }}"
                       data-notes="{{ notes|default:'' }}"
                       data-type="{{ ev.type }}"
                       data-day="{{ date|date:'d.m.Y' }}"
                       data-lesson-id="{{ ev.id }}"
                       data-time="{{ st }}{% if en %}‚Äì{{ en }}{% endif %}"
                       {% if ev.type == 'lesson' %}
                         data-type="lesson"
                         data-lesson-id="{{ ev.id }}"
                         data-subject="{{ ev.subject }}"
                         data-teacher="{{ ev.teacher }}"
                         data-place="{{ ev.place }}"
                       {% else %}
                         data-type="task"
                         data-description="{{ ev.description }}"
                         data-place="{{ ev.place }}"
                         data-task-id="{{ ev.id }}"
                         {% if ev.attachment %}
                          data-attachment-url="{{ ev.attachment.url }}"
                          data-attachment-name="{{ ev.attachment.name|basename }}"
                        {% endif %}
                       {% endif %}
                  >
                    <div class="line-content">
                      <div><strong>{{ st }}{% if en %}‚Äì{{ en }}{% endif %}</strong></div>
                      {% if ev.type == 'lesson' %}
                        <div>{{ ev.subject }}</div>
                        <div>{{ ev.teacher }}</div>
                        <div>{{ ev.place }}</div>
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                      {% else %}
                        <div>{{ ev.description }}</div>
                        {% if ev.place %}<div><em>{{ ev.place }}</em></div>{% endif %}
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                        {% if ev.attachment %}
                          <div><a href="{{ ev.attachment.url }}" target="_blank">üìé –§–∞–π–ª</a></div>
                        {% endif %}
                        <button
                          class="delete-task-button"
                          data-task-id="{{ ev.id }}"
                          style="color: red; margin-top:5px;"
                        >
                          –£–¥–∞–ª–∏—Ç—å
                        </button>
                      {% endif %}
                    </div>
                  </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>

        {# –í–° #}
        <div class="schedule-row third-row">
          {% for date, events in schedule_by_date|slice:"6:7" %}
            <div class="day-column {{ date|date:'EEEE'|lower }}">
              <div class="day-header">{{ date|date:"l, d F" }}</div>
              <button class="add-task-button" data-date="{{ date|date:'Y-m-d' }}">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
              <div class="events-list">
                {% for ev in events %}
                  {% with st=ev.start_time en=ev.end_time notes=ev.notes %}
                  <div class="schedule-line {% if ev.done %}done{% elif ev.type == 'task' %}pending{% endif %}"
                       data-key="{{ date|date:'Y-m-d' }}_{{ st }}"
                       data-notes="{{ notes|default:'' }}"
                       data-type="{{ ev.type }}"
                       data-day="{{ date|date:'d.m.Y' }}"
                       data-lesson-id="{{ ev.id }}"
                       data-time="{{ st }}{% if en %}‚Äì{{ en }}{% endif %}"
                       {% if ev.type == 'lesson' %}
                         data-type="lesson"
                         data-lesson-id="{{ ev.id }}"
                         data-subject="{{ ev.subject }}"
                         data-teacher="{{ ev.teacher }}"
                         data-place="{{ ev.place }}"
                       {% else %}
                         data-type="task"
                         data-description="{{ ev.description }}"
                         data-place="{{ ev.place }}"
                         data-task-id="{{ ev.id }}"
                         {% if ev.attachment %}
                          data-attachment-url="{{ ev.attachment.url }}"
                          data-attachment-name="{{ ev.attachment.name|basename }}"
                        {% endif %}
                       {% endif %}
                  >
                    <div class="line-content">
                      <div><strong>{{ st }}{% if en %}‚Äì{{ en }}{% endif %}</strong></div>
                      {% if ev.type == 'lesson' %}
                        <div>{{ ev.subject }}</div>
                        <div>{{ ev.teacher }}</div>
                        <div>{{ ev.place }}</div>
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                      {% else %}
                        <div>{{ ev.description }}</div>
                        {% if ev.place %}<div><em>{{ ev.place }}</em></div>{% endif %}
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                        {% if ev.attachment %}
                          <div><a href="{{ ev.attachment.url }}" target="_blank">üìé –§–∞–π–ª</a></div>
                        {% endif %}
                        <button
                          class="delete-task-button"
                          data-task-id="{{ ev.id }}"
                          style="color: red; margin-top:5px; align: center;"
                        >
                          –£–¥–∞–ª–∏—Ç—å
                        </button>
                      {% endif %}
                    </div>
                  </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>



{% elif user_role == 'teacher' %}
    <div class="schedule-controls">
      <form method="GET" action="{% url 'home:schedule' %}" class="schedule-form">
        <div class="form-row">
          <div class="input-block">
            <label for="teacher_fullname">–§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="teacher_fullname" name="teacher_fullname"
                   placeholder="–≤–≤–µ–¥–∏—Ç–µ –§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é" required>
          </div>
          <div class="input-block">
            <label for="scheduleDate">–î–∞—Ç–∞</label>
            <input type="date" id="scheduleDate" name="scheduleDate"
                   value="{{ selected_date }}">
          </div>
        </div>
        <button type="submit" class="auth-button">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
      </form>
    </div>
    {% if schedule_by_date %}
      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º -->
      <div class="week-info"
           data-week-start="{{ week_start|date:'Y-m-d' }}"
           data-group="{{ selected_group }}"
           data-teacher-fullname="{{ teacher_fullname }}"
      >
        <span class="prev-week">&larr;</span>
        <strong>–ù–µ–¥–µ–ª—è:&nbsp;</strong>
        {{ week_start|date:"d F Y" }} ‚Äì {{ week_end|date:"d F Y" }}
        <span class="next-week">&rarr;</span>
      </div>
      <a href="{% url 'home:export_ics' %}?teacher={{ teacher_fullname }}&scheduleDate={{ selected_date }}" class="auth-button" style="margin-left:1em">
        –≠–∫—Å–ø–æ—Ä—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å (.ics)
      </a>
      <div class="schedule-wrapper">
        {# –ü–ù‚Äì–°–† #}
        <div class="schedule-row first-row">
          {% for date, events in schedule_by_date|slice:":3" %}
            <div class="day-column">
              <div class="day-header">{{ date|date:"l, d F" }}</div>
              <button class="add-task-button" data-date="{{ date|date:'Y-m-d' }}">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
              <div class="events-list">
                {% for ev in events %}
                  {% with st=ev.start_time en=ev.end_time notes=ev.notes %}
                  <div class="schedule-line {% if ev.done %}done{% elif ev.type == 'task' %}pending{% endif %}"
                       data-key="{{ date|date:'Y-m-d' }}_{{ st }}"
                       data-notes="{{ notes|default:'' }}"
                       data-type="{{ ev.type }}"
                       data-day="{{ date|date:'d.m.Y' }}"
                       data-time="{{ st }}{% if en %}‚Äì{{ en }}{% endif %}"
                       data-lesson-id="{{ ev.id }}"
                       {% if ev.type == 'lesson' %}
                         data-type="lesson"
                         data-lesson-id="{{ ev.id }}"
                         data-subject="{{ ev.subject }}"
                         data-teacher="{{ ev.teacher }}"
                         data-place="{{ ev.place }}"
                       {% else %}
                         data-type="task"
                         data-description="{{ ev.description }}"
                         data-place="{{ ev.place }}"
                         data-task-id="{{ ev.id }}"
                         {% if ev.attachment %}
                          data-attachment-url="{{ ev.attachment.url }}"
                          data-attachment-name="{{ ev.attachment.name|basename }}"
                        {% endif %}
                       {% endif %}
                  >
                    <div class="line-content">
                      <div><strong>{{ st }}{% if en %}‚Äì{{ en }}{% endif %}</strong></div>
                      {% if ev.type == 'lesson' %}
                        <div>{{ ev.subject }}</div>
                        <div>{{ ev.teacher }}</div>
                        <div>{{ ev.place }}</div>
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                      {% else %}
                        <div>{{ ev.description }}</div>
                        {% if ev.place %}<div><em>{{ ev.place }}</em></div>{% endif %}
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                        {% if ev.attachment %}
                          <div><a href="{{ ev.attachment.url }}" target="_blank">üìé –§–∞–π–ª</a></div>
                        {% endif %}
                        <button
                          class="delete-task-button"
                          data-task-id="{{ ev.id }}"
                          style="color: red; margin-top:5px;"
                        >
                          –£–¥–∞–ª–∏—Ç—å
                        </button>
                      {% endif %}
                    </div>
                  </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>


        {# –ß–¢‚Äì–°–ë #}
        <div class="schedule-row second-row">
          {% for date, events in schedule_by_date|slice:"3:6" %}
            <div class="day-column {{ date|date:'EEEE'|lower }}">
              <div class="day-header">{{ date|date:"l, d F" }}</div>
              <button class="add-task-button" data-date="{{ date|date:'Y-m-d' }}">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
              <div class="events-list">
                {% for ev in events %}
                  {% with st=ev.start_time en=ev.end_time notes=ev.notes %}
                  <div class="schedule-line {% if ev.done %}done{% elif ev.type == 'task' %}pending{% endif %}"
                       data-key="{{ date|date:'Y-m-d' }}_{{ st }}"
                       data-notes="{{ notes|default:'' }}"
                       data-type="{{ ev.type }}"
                       data-day="{{ date|date:'d.m.Y' }}"
                       data-lesson-id="{{ ev.id }}"
                       data-time="{{ st }}{% if en %}‚Äì{{ en }}{% endif %}"
                       {% if ev.type == 'lesson' %}
                         data-type="lesson"
                         data-lesson-id="{{ ev.id }}"
                         data-subject="{{ ev.subject }}"
                         data-teacher="{{ ev.teacher }}"
                         data-place="{{ ev.place }}"
                       {% else %}
                         data-type="task"
                         data-description="{{ ev.description }}"
                         data-place="{{ ev.place }}"
                         data-task-id="{{ ev.id }}"
                         {% if ev.attachment %}
                          data-attachment-url="{{ ev.attachment.url }}"
                          data-attachment-name="{{ ev.attachment.name|basename }}"
                        {% endif %}
                       {% endif %}
                  >
                    <div class="line-content">
                      <div><strong>{{ st }}{% if en %}‚Äì{{ en }}{% endif %}</strong></div>
                      {% if ev.type == 'lesson' %}
                        <div>{{ ev.subject }}</div>
                        <div>{{ ev.teacher }}</div>
                        <div>{{ ev.place }}</div>
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                      {% else %}
                        <div>{{ ev.description }}</div>
                        {% if ev.place %}<div><em>{{ ev.place }}</em></div>{% endif %}
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                        {% if ev.attachment %}
                          <div><a href="{{ ev.attachment.url }}" target="_blank">üìé –§–∞–π–ª</a></div>
                        {% endif %}
                        <button
                          class="delete-task-button"
                          data-task-id="{{ ev.id }}"
                          style="color: red; margin-top:5px;"
                        >
                          –£–¥–∞–ª–∏—Ç—å
                        </button>
                      {% endif %}
                    </div>
                  </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>

        {# –í–° #}
        <div class="schedule-row third-row">
          {% for date, events in schedule_by_date|slice:"6:7" %}
            <div class="day-column {{ date|date:'EEEE'|lower }}">
              <div class="day-header">{{ date|date:"l, d F" }}</div>
              <button class="add-task-button" data-date="{{ date|date:'Y-m-d' }}">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
              <div class="events-list">
                {% for ev in events %}
                  {% with st=ev.start_time en=ev.end_time notes=ev.notes %}
                  <div class="schedule-line {% if ev.done %}done{% elif ev.type == 'task' %}pending{% endif %}"
                       data-key="{{ date|date:'Y-m-d' }}_{{ st }}"
                       data-notes="{{ notes|default:'' }}"
                       data-type="{{ ev.type }}"
                       data-day="{{ date|date:'d.m.Y' }}"
                       data-lesson-id="{{ ev.id }}"
                       data-time="{{ st }}{% if en %}‚Äì{{ en }}{% endif %}"
                       {% if ev.type == 'lesson' %}
                         data-type="lesson"
                         data-lesson-id="{{ ev.id }}"
                         data-subject="{{ ev.subject }}"
                         data-teacher="{{ ev.teacher }}"
                         data-place="{{ ev.place }}"
                       {% else %}
                         data-type="task"
                         data-description="{{ ev.description }}"
                         data-place="{{ ev.place }}"
                         data-task-id="{{ ev.id }}"
                         {% if ev.attachment %}
                          data-attachment-url="{{ ev.attachment.url }}"
                          data-attachment-name="{{ ev.attachment.name|basename }}"
                        {% endif %}
                       {% endif %}
                  >
                    <div class="line-content">
                      <div><strong>{{ st }}{% if en %}‚Äì{{ en }}{% endif %}</strong></div>
                      {% if ev.type == 'lesson' %}
                        <div>{{ ev.subject }}</div>
                        <div>{{ ev.teacher }}</div>
                        <div>{{ ev.place }}</div>
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                      {% else %}
                        <div>{{ ev.description }}</div>
                        {% if ev.place %}<div><em>{{ ev.place }}</em></div>{% endif %}
                        {% if notes %}<div class="notes">{{ notes }}</div>{% endif %}
                        {% if ev.attachment %}
                          <div><a href="{{ ev.attachment.url }}" target="_blank">üìé –§–∞–π–ª</a></div>
                        {% endif %}
                        <button
                          class="delete-task-button"
                          data-task-id="{{ ev.id }}"
                          style="color: red; margin-top:5px; align: center;"
                        >
                          –£–¥–∞–ª–∏—Ç—å
                        </button>
                      {% endif %}
                    </div>
                  </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
{% else %}



  <p>
    –û—à–∏–±–∫–∞: –†–æ–ª—å - –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
  </p>
{% endif %}

{# –ú–æ–¥–∞–ª–∫–∞ –ø–∞—Ä—ã #}
<div id="lesson-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeLessonModal()">&times;</span>
    <h3 style="text-align:center;">–î–µ—Ç–∞–ª–∏ –ø–∞—Ä—ã</h3>
    <div id="lesson-modal-body">
      <p><strong>–î–µ–Ω—å:</strong> <span id="lesson-day"></span></p>
      <p><strong>–í—Ä–µ–º—è:</strong> <span id="lesson-time"></span></p>
      <p><strong>–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞:</strong> <span id="lesson-subject"></span></p>
      <p><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> <span id="lesson-teacher"></span></p>
      <p><strong>–ê—É–¥–∏—Ç–æ—Ä–∏—è:</strong> <span id="lesson-place"></span></p>
      <label for="lesson-notes">–ó–∞–º–µ—Ç–∫–∏:</label>
      <textarea id="lesson-notes" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É..."></textarea>
      <p>
        <label>
          –í—ã–ø–æ–ª–Ω–µ–Ω–æ <input type="checkbox" id="lesson-done">
        </label>
      </p>
      <form id="upload-lesson-attachment-form" enctype="multipart/form-data">
        <p>
          <strong>–§–∞–π–ª:</strong>
          <span id="current-lesson-attachment">
            {% if ev.attachment %}
              <a href="{{ ev.attachment.url }}" target="_blank">
                {{ ev.attachment.name|slice:"-0:"|split:"/"|last }}
              </a>
            {% else %}
              –Ω–µ—Ç
            {% endif %}
          </span>
        </p>
        <div class="input-block">
          <label for="lesson-upload-file">–ó–∞–º–µ–Ω–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª:</label>
          <input type="file" id="lesson-upload-file" name="attachment">
        </div>
        <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
      </form>

      {% if user_role == 'teacher' and teacher_fullname == request.user.full_name %}
      <hr>
      <h3>–ü–æ—Å–µ—â–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
      <p><strong>–ì—Ä—É–ø–ø—ã:</strong>
        <span id="lesson-groups"></span>
      </p>
      <table id="attendance-table">
        <thead>
          <tr><th>–°—Ç—É–¥–µ–Ω—Ç</th><th>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="attendance-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</button>
      {% endif %}

    </div>
  </div>
</div>

{# –ú–æ–¥–∞–ª–∫–∞ –∑–∞–¥–∞—á–∏ #}
<div id="task-detail-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeTaskDetailModal()">&times;</span>
    <h3 style="text-align:center;">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</h3>
    <div id="task-detail-modal-body">
      <p><strong>–î–µ–Ω—å:</strong> <span id="task-day"></span></p>
      <p><strong>–í—Ä–µ–º—è:</strong> <span id="task-time"></span></p>
      <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span id="task-desc"></span></p>
      <p><strong>–ú–µ—Å—Ç–æ:</strong> <span id="task-place"></span></p>
      <label for="task-notes-detail">–ó–∞–º–µ—Ç–∫–∏:</label>
      <textarea id="task-notes-detail" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É..."></textarea>
      <p>
        <label>
          –í—ã–ø–æ–ª–Ω–µ–Ω–æ <input type="checkbox" id="task-done">
        </label>
      </p>
      <form id="upload-attachment-form" enctype="multipart/form-data">
        <p>
          <strong>–§–∞–π–ª:</strong>
          <span id="current-attachment">
            {% if ev.attachment %}
              <a href="{{ ev.attachment.url }}" target="_blank">{{ ev.attachment.name|basename }}</a>
            {% else %}
              –Ω–µ—Ç
            {% endif %}
          </span>
        </p>
        <div class="input-block">
          <label for="upload-file">–ó–∞–º–µ–Ω–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª:</label>
          <input type="file" id="upload-file" name="attachment">
        </div>
        <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
      </form>
    </div>
  </div>
</div>


{# –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ #}
<div id="task-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeTaskModal()">&times;</span>
    <h3 style="text-align:center;">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
    <form id="task-form" method="post" action="{% url 'home:create_task' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="group" value="{{ selected_group }}">
      <input type="hidden" name="date" id="task-date">

      <div class="input-block">
        <label for="task-time">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</label>
        <input type="time" id="task-time" name="start_time" required>
      </div>

      <div class="input-block">
        <label for="task-end-time">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
        <input type="time" id="task-end-time" name="end_time">
      </div>

      <div class="input-block">
        <label for="task-place">–ú–µ—Å—Ç–æ:</label>
        <input type="text" id="task-place" name="place">
      </div>

      <div class="input-block">
        <label for="task-desc">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
        <textarea id="task-desc" name="description" required></textarea>
      </div>

      <div class="input-block">
        <label for="task-notes">–ó–∞–º–µ—Ç–∫–∏:</label>
        <textarea id="task-notes" name="notes"></textarea>
      </div>

      <div class="input-block">
        <label for="task-file">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª:</label>
        <input type="file" id="task-file" name="attachment">
      </div>

      <div class="input-block">
        <label><input type="checkbox" name="done"> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
      </div>

      <button type="submit" class="auth-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </form>
  </div>
</div>

{# –°–∫—Ä–∏–ø—Ç—ã: –º–æ–¥–∞–ª–∫–∏, –∑–∞–º–µ—Ç–∫–∏, —Å—Ç–∞—Ç—É—Å—ã, —Å—Ç—Ä–µ–ª–∫–∏, –ø–æ–∏—Å–∫ #}
<script>
  const storageKey = 'planora_notes';
  let allNotes = JSON.parse(localStorage.getItem(storageKey) || '{}');

  // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  const myFullName = "{{ request.user.full_name }}";
  const myRole     = "{{ user_role }}";

  function openLessonModal(day, time, subject, teacher, place, key, lessonId, groups) {
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏ –ø–∞—Ä—ã
    document.getElementById('lesson-day').innerText     = day;
    document.getElementById('lesson-time').innerText    = time;
    document.getElementById('lesson-subject').innerText = subject;
    document.getElementById('lesson-teacher').innerText = teacher;
    document.getElementById('lesson-place').innerText   = place;

    // –ó–∞–º–µ—Ç–∫–∏ –∏–∑ localStorage
    const noteData = allNotes[key] || {};
    document.getElementById('lesson-notes').value   = noteData.note || '';
    document.getElementById('lesson-done').checked  = noteData.done || false;

    // –î–∞–Ω–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏
    const modal = document.getElementById('lesson-modal');
    modal.dataset.currentKey = key;
    modal.dataset.lessonId   = lessonId;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø (–µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç)
    const groupsSpan = modal.querySelector('#lesson-groups');
    if (groupsSpan) {
      groupsSpan.innerText = groups.join(', ');
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
    const attendanceSection = modal.querySelector('#attendance-table')?.closest('table')?.parentNode;
    if (attendanceSection && myRole === 'teacher' && teacher === myFullName) {
      const tbody = modal.querySelector('#attendance-table tbody');
      tbody.innerHTML = '';

      fetch(`{% url 'home:lesson_students' %}?lesson_id=${lessonId}`)
        .then(response => response.json())
        .then(data => {
          let hasStudents = false;
          console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
          data.groups.forEach(group => {
            if (group.students.length > 0) {
              hasStudents = true;

              // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã
              const groupRow = document.createElement('tr');
              groupRow.innerHTML = `
                <td colspan="3" style="font-weight:bold; background:#f0f0f0;">${group.name}</td>
              `;
              tbody.appendChild(groupRow);

              // –°—Ç—É–¥–µ–Ω—Ç—ã –≥—Ä—É–ø–ø—ã
              group.students.forEach(st => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${st.full_name}</td>
                  <td><input type="checkbox" data-student-id="${st.id}"></td>
                  <td><input type="text" data-student-id="${st.id}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></td>
                `;
                tbody.appendChild(tr);
              });
            }
          });

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
          attendanceSection.style.display = hasStudents ? 'block' : 'none';
        });
    } else if (attendanceSection) {
      attendanceSection.style.display = 'none';
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    modal.classList.remove('hidden');
    modal.style.display = 'block';
  }


  function closeLessonModal() {
    const modal = document.getElementById('lesson-modal');
    const key   = modal.dataset.currentKey;
    const note  = document.getElementById('lesson-notes').value;
    const done  = document.getElementById('lesson-done').checked;
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    allNotes[key] = { note, done };
    localStorage.setItem(storageKey, JSON.stringify(allNotes));
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —è—á–µ–π–∫–∏
    const cell = document.querySelector(`.schedule-line[data-key="${key}"]`);
    if (cell) {
      cell.classList.toggle('done', done);
      cell.classList.toggle('pending', !done);
    }
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }

  function openTaskDetailModal(line, day, time, desc, place, key, taskId) {
    document.getElementById('task-day').innerText        = day;
    document.getElementById('task-time').innerText       = time;
    document.getElementById('task-desc').innerText       = desc;
    document.getElementById('task-place').innerText      = place;
    const noteData = allNotes[key] || {};
    document.getElementById('task-notes-detail').value   = noteData.note || '';
    document.getElementById('task-done').checked         = noteData.done || false;

    const modal = document.getElementById('task-detail-modal');
    modal.dataset.currentKey = key;
    modal.dataset.taskId     = taskId;
    // –§–∞–π–ª –∑–∞–¥–∞—á–∏
    const attUrl  = line.dataset.attachmentUrl;
    const attName = line.dataset.attachmentName;
    const cur     = document.getElementById('current-attachment');
    cur.innerHTML = attUrl
      ? `<a href="${attUrl}" target="_blank">${attName}</a>`
      : '–Ω–µ—Ç';

    modal.classList.remove('hidden');
    modal.style.display = 'block';
  }

  function closeTaskDetailModal() {
    const modal = document.getElementById('task-detail-modal');
    const key   = modal.dataset.currentKey;
    const note  = document.getElementById('task-notes-detail').value;
    const done  = document.getElementById('task-done').checked;
    allNotes[key] = { note, done };
    localStorage.setItem(storageKey, JSON.stringify(allNotes));
    const cell = document.querySelector(`.schedule-line[data-key="${key}"]`);
    if (cell) {
      cell.classList.toggle('done', done);
      cell.classList.toggle('pending', !done);
    }
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }

  function openTaskModal(date) {
    document.getElementById('task-date').value = date;
    const m = document.getElementById('task-modal');
    m.classList.remove('hidden');
    m.style.display = 'block';
  }

  function closeTaskModal() {
    const modal = document.getElementById('task-modal');
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }

  document.addEventListener('DOMContentLoaded', () => {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –ø–∞—Ä–µ –∏–ª–∏ –∑–∞–¥–∞—á–µ
    document.querySelectorAll('.schedule-line').forEach(line => {
      line.addEventListener('click', e => {
        e.stopPropagation();
        const type    = line.dataset.type;
        const key     = line.dataset.key;
        const day     = line.dataset.day;
        const time    = line.dataset.time;
        if (type === 'lesson') {
          openLessonModal(
            day,
            time,
            line.dataset.subject,
            line.dataset.teacher,
            line.dataset.place,
            key,
            line.dataset.lessonId,
            (line.dataset.groups || '').split(',')
          );
        } else if (type === 'task') {
          openTaskDetailModal(
            line, day, time,
            line.dataset.description,
            line.dataset.place,
            key,
            line.dataset.taskId
          );
        }
      });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∫ –∑–∞–¥–∞—á–µ
    document.getElementById('upload-attachment-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const inp = document.getElementById('upload-file');
      if (!inp.files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
      const file = inp.files[0];
      const modal = document.getElementById('task-detail-modal');
      const taskId = modal.dataset.taskId;
      const url = `/task/${taskId}/upload_task_attachment/`;
      const data = new FormData();
      data.append('attachment', file);
      const csrftoken = getCookie('csrftoken');
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: data
      });
      const json = await resp.json();
      if (json.success) {
        document.getElementById('current-attachment').innerHTML =
          `<a href="${json.url}" target="_blank">${json.filename}</a>`;
        alert('–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
      } else {
        alert('–û—à–∏–±–∫–∞: ' + (json.error || ''));
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∫ –ø–∞—Ä–µ
    document.getElementById('upload-lesson-attachment-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const inp = document.getElementById('lesson-upload-file');
      if (!inp.files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
      const file = inp.files[0];
      const modal    = document.getElementById('lesson-modal');
      const lessonId = modal.dataset.lessonId;
      const url      = `/lesson/${lessonId}/upload_lesson_attachment/`;
      const data     = new FormData();
      data.append('attachment', file);
      const csrftoken = getCookie('csrftoken');
      const resp      = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: data
      });
      const json = await resp.json();
      if (!json.success) return alert(json.error || '–û—à–∏–±–∫–∞');
      document.getElementById('current-lesson-attachment').innerHTML =
        `<a href="${json.url}" target="_blank">${json.filename}</a>`;
      alert('–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    });

    // –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É"
    document.querySelectorAll('.add-task-button').forEach(button => {
      button.addEventListener('click', () => openTaskModal(button.dataset.date));
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ —Ñ–æ–Ω–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
    window.addEventListener('click', e => {
      if (e.target === document.getElementById('task-modal')) closeTaskModal();
      if (e.target === document.getElementById('lesson-modal')) closeLessonModal();
      if (e.target === document.getElementById('task-detail-modal')) closeTaskDetailModal();
    });

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º
    const wi = document.querySelector('.week-info'),
          [wy, wm, wd] = wi.dataset.weekStart.split('-').map(n=>+n),
          form = document.querySelector('.schedule-form'),
          dateInput = document.getElementById('scheduleDate');
    function shiftWeek(delta) {
      let dt = new Date(wy, wm-1, wd);
      dt.setDate(dt.getDate()+delta);
      const y = dt.getFullYear(),
            m = String(dt.getMonth()+1).padStart(2,'0'),
            d = String(dt.getDate()).padStart(2,'0'),
            newDate = `${y}-${m}-${d}`;
      dateInput.value = newDate;
      form.submit();
    }
    document.querySelector('.prev-week').onclick = ()=>shiftWeek(-7);
    document.querySelector('.next-week').onclick = ()=>shiftWeek(+7);

    // –ü–æ–∏—Å–∫
    document.getElementById('search-input')?.addEventListener('input', function(){
      const q = this.value.toLowerCase();
      document.querySelectorAll('.schedule-line').forEach(line=>{
        const content = line.querySelector('.line-content').innerText.toLowerCase();
        const notes   = (line.dataset.notes   || '').toLowerCase();
        const desc    = (line.dataset.description || '').toLowerCase();
        const subj    = (line.dataset.subject || '').toLowerCase();
        const hay    = content+' '+notes+' '+desc+' '+subj;
        line.style.display = hay.includes(q) ? '' : 'none';
      });
    });


    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
    document.getElementById('attendance-save')?.addEventListener('click', () => {
      const tbody = document.querySelector('#attendance-table tbody');
      const payload = Array.from(tbody.querySelectorAll('tr')).map(tr => {
        const cb = tr.querySelector('input[type="checkbox"]'),
              txt = tr.querySelector('input[type="text"]');
        if (!cb || !txt) return null;
        return {
          student_id: cb.dataset.studentId,
          present: cb.checked,
          comment: txt.value
        };
      });
      const lessonId = document.getElementById('lesson-modal').dataset.lessonId;
      fetch(`{% url 'home:save_attendance' %}?lesson_id=${lessonId}`, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ records: payload })
      }).then(()=>{
        closeLessonModal();
      });
    });
  });
</script>






<script>
document.querySelectorAll('.task-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
        const taskId = this.dataset.taskId;

        fetch(`/toggle_task_done/${taskId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskDiv = document.getElementById(`task-${taskId}`);
                if (data.done) {
                    taskDiv.classList.remove('not-done');
                    taskDiv.classList.add('done');
                } else {
                    taskDiv.classList.remove('done');
                    taskDiv.classList.add('not-done');
                }
            }
        });
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.delete-task-button').forEach(btn => {
    btn.addEventListener('click', async e => {
      const id = btn.dataset.taskId;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;

      // —Å–æ–±—Ä–∞—Ç—å CSRF‚Äë—Ç–æ–∫–µ–Ω
      function getCookie(name) {
        let v = null;
        document.cookie.split(';').forEach(c => {
          let [k,val] = c.trim().split('=');
          if (k === name) v = decodeURIComponent(val);
        });
        return v;
      }
      const csrftoken = getCookie('csrftoken');

      try {
        const resp = await fetch("{% url 'home:delete_task' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({ task_id: id })
        });
        const data = await resp.json();
        if (data.success) {
          // –ª–∏–±–æ —É–¥–∞–ª—è–µ–º —Å—Ä–∞–∑—É –∏–∑ DOM:
          //btn.closest('.schedule-line').remove();
          // –ª–∏–±–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É:
          location.reload();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
      } catch (err) {
        alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
      }
    });
  });
});
</script>



<style>
  input[type="text"],
  input[type="time"],
  input[type="date"],
  input[type="file"],
  textarea {
    color: black; /* —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
    background-color: white; /* —Ñ–æ–Ω */
    border: 1px solid #ccc;
    padding: 6px;
    border-radius: 4px;
    width: 100%;
    box-sizing: border-box;
  }

  textarea::placeholder,
  input::placeholder {
    color: #888;
  }
</style>

{% endblock %}
